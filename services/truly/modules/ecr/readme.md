# Volly Terraform Library Module | ECR Repository

**Current Version**: v2.0

This module creates an ECR Repository for storage of container images. 


## Known Issues
There are no known issues with this module.


## USAGE

#### Providers
From a root module, set a provider for the account in which to provision the ECR Repository. When calling this Library module, set the provider equal to *aws.account*.



#### Features 

##### Repository Encryption
The module supports encryption of the ECR Repository via AWS KMS. This feature is enabled by providing a valid KMS Key ARN to the *kms_key_arn* variable.


##### Tag Immutability
The module supports enabling Tag Immutability for images stored in the ECR Repository. This feature is enabled when *enable_tag_immutability* is set to *true*.

Tag Immutability will ensure that container image tags cannot be moved between containers in the ECR Repository. This feature can improve security by ensuring consistency of the container image being deployed.


##### Lifecycle Policies
Lifecycle Policies allow for the configuration of rules that dictate how old images will be expired. For example, a policy may be configured to expire images after *n* days, unless the images have specific tags.

###### Default Lifecycle Policy
The module supports applying a default Lifecycle to the ECR Repository. This feature is enabled when the *attach_lifecycle_policy* variable is set to *true*.

If a Custom Lifecycle Policy is provided, the Default Lifecycle Policy will be overwritten, even if *attach_lifecycle_policy* is set to *true*

The Default Lifecycle will delete untagged container images after seven days.

###### Custom Lifecycle Policy
The module supports applying a custom Lifecycle Policy to the ECR Repository. This feature is enabled when a valid JSON-Formatted Lifecycle Policy is provided to the *lifecycle_policy* variable.



#### Dependencies
This module may require multiple resources to be created prior to deploying the module, depending on the features that are enabled within the module. All of the listed dependencies may be deployed via Terraform using existing Library Modules. 

The following resources are always required when provisioning ECR Repositories that are encrypted:

  * KMS Key



## Example
#### Example with only *required* variables
    module "ecr" {
      source       = "git::ssh://git@bitbucket.org/v-dso/ecr"
      environment  = "prod"
      project      = "volly-example-project"
      service      = "example-service"

      providers = {
        aws.account = aws.example
      }
    }


#### Example with *all* variables
    module "ecr" {
      source                  = "git::ssh://git@bitbucket.org/v-dso/ecr"
      environment             = "prod"
      project                 = "volly-example-project"
      service                 = "example-service"
      kms_key_arn             = "arn:aws:kms:us-east-1:xxxxxxxxxxxx:key/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
      enable_tag_immutability = true
      attach_lifecycle_policy = true
      lifecycle_policy        = data.lifecycle_policy.json

      providers = {
        aws.account = aws.example
      }
    }



## Variables

#### Required Variables
* **environment** *string* = Environment that the ECR Repository supports. 
    * Valid options are 'cit', 'uat', 'prod', or 'core'.
* **project** *string* = Friendly name of the project the ECR Repository supports. 
    * Provided value is used to establish a name for the ECR Repository.
      * ECR Repository name is generated by appending the *service_name* to the *project*
* **service_name** *string* = Friendly Name of the service the ECR Repository supports.


#### Optional Variables
##### Repository Encryption
* **kms_key_arn** *string* = The ARN of the KMS key used to encrypt the ECR Repository.


##### Tag Immutability
* **enable_tag_immutability** *boolean* = Sets whether to make Image Tags Immutable.
    * Defaults to *false* (tags are mutable).


##### Lifecycle Policies
###### Default Lifecycle Policy
* **attach_lifecycle_policy** *boolean* = Sets whether to attach a default Lifecycle Policy to the ECR Repository.
    * Defaults to *false*.

###### Custom Lifecycle Policy
* **lifecycle_policy** *object* = Custom Lifecycle Policy to attach to the ECR Repository.
    * Must be a valid JSON-Formatted Lifecycle Policy.


## Outputs

#### ECR Repository Outputs
* **name** = Friendly name of the ECR Repository.
* **arn** = ARN of the ECR Repository.
* **registry_id** = ID of ECR Registry where the ECR Repository was created.
* **repository_url** = URL of the ECR Repository.